<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Generator Pro</title>
    
    <!-- React & ReactDOM (loaded via CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to handle JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-400: #fb923c;
            --orange-600: #ea580c;
            
            --purple-50: #faf5ff;
            --purple-100: #f3e8ff;
            --purple-400: #c084fc;
            --purple-600: #9333ea;

            --emerald-50: #ecfdf5;
            --emerald-100: #d1fae5;
            --emerald-600: #059669;
            --emerald-700: #047857;
            
            --rose-50: #fff1f2;
            --rose-100: #ffe4e6;
            --rose-600: #e11d48;

            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-500: #ef4444;
            --red-600: #dc2626;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--slate-50);
            color: var(--slate-800);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1250px; margin: 0 auto; }

        /* Utility Classes */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mr-2 { margin-right: 8px; }
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .p-5 { padding: 20px; }
        .p-6 { padding: 24px; }
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Custom Components */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--slate-200);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: var(--blue-600); color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: var(--blue-700); }
        
        .btn-secondary { background: white; color: var(--slate-700); border-color: var(--slate-300); }
        .btn-secondary:hover { background: var(--slate-50); }
        
        .btn-success { background: var(--emerald-600); color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-success:hover { background: var(--emerald-700); }
        
        .btn-danger { background: var(--red-50); color: var(--red-600); border-color: var(--red-100); }
        .btn-danger:hover { background: var(--red-100); }

        .btn-icon { padding: 8px; background: transparent; color: var(--slate-400); border-radius: 50%; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-icon:hover { background: var(--slate-100); color: var(--slate-600); }

        .input-group {
            display: flex;
            align-items: center;
            background: white;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid var(--slate-200);
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--slate-300);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .form-input:focus { outline: 2px solid var(--blue-500); border-color: transparent; }

        /* Role Toggles */
        .role-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--slate-200);
            cursor: pointer;
            background: white;
            color: var(--slate-500);
            transition: all 0.2s;
            text-align: center;
        }
        .role-checkbox.active-main { background: var(--blue-50); border-color: var(--blue-200); color: var(--blue-700); }
        .role-checkbox.active-floater { background: var(--orange-50); border-color: var(--orange-200); color: var(--orange-600); }
        .role-checkbox.active-junior { background: var(--purple-50); border-color: var(--purple-200); color: var(--purple-600); }
        .role-checkbox.active-farsi { background: var(--rose-50); border-color: var(--rose-100); color: var(--rose-600); }

        /* Layout Grid */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        .shift-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }

        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: 350px 1fr; }
            .shift-grid { grid-template-columns: 1fr 1fr; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .header-row { flex-direction: row; }
        }
        
        @media (max-width: 1023px) {
             .header-row { flex-direction: column; align-items: flex-start; }
        }

        /* Slot Styling */
        .slot {
            position: relative;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid;
            transition: all 0.2s;
        }
        .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .slot-content { display: flex; align-items: center; gap: 8px; }
        .slot-select {
            background: transparent;
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--slate-700);
            width: 100%;
            cursor: pointer;
            outline: none;
        }

        /* Slot Themes */
        .theme-blue { background: var(--blue-50); border-color: var(--blue-100); }
        .theme-blue.locked { background: var(--blue-100); border-color: var(--blue-500); }
        .theme-blue .icon { color: var(--blue-500); }
        
        .theme-orange { background: var(--orange-50); border-color: var(--orange-100); }
        .theme-orange.locked { background: var(--orange-100); border-color: var(--orange-400); }
        .theme-orange .icon { color: var(--orange-400); }

        .theme-emerald { background: var(--emerald-50); border-color: var(--emerald-100); }
        .theme-emerald.locked { background: var(--emerald-100); border-color: var(--emerald-600); }
        .theme-emerald .icon { color: var(--emerald-600); }

        .theme-rose { background: var(--rose-50); border-color: var(--rose-100); }
        .theme-rose.locked { background: var(--rose-100); border-color: var(--rose-600); }
        .theme-rose .icon { color: var(--rose-600); }

        /* Badges */
        .badge { 
            font-size: 10px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid; 
            font-weight: 600; 
            cursor: pointer;
            user-select: none;
        }
        .badge:hover { opacity: 0.8; }
        .badge-purple { background: var(--purple-50); color: var(--purple-600); border-color: var(--purple-100); }
        .badge-blue { background: var(--blue-50); color: var(--blue-600); border-color: var(--blue-100); }
        .badge-orange { background: var(--orange-50); color: var(--orange-600); border-color: var(--orange-100); }
        .badge-rose { background: var(--rose-50); color: var(--rose-600); border-color: var(--rose-100); }
        .badge-gray { background: var(--slate-50); color: var(--slate-400); border-color: var(--slate-200); }

        /* Animation */
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* SVG Icons */
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-lg { width: 32px; height: 32px; }
        .icon-md { width: 20px; height: 20px; }
        
        .scroll-area { overflow-y: auto; max-height: 550px; padding-right: 8px; }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background: var(--slate-300); border-radius: 3px; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const Icons = {
            Trash2: () => <svg className="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: () => <svg className="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Calendar: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            User: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            RefreshCw: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Copy: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Check: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            AlertCircle: () => <svg className="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            History: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 5.6 5.6L3 8"/></svg>,
            Lock: ({size}) => <svg className="icon" style={{width: size, height: size}} viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: ({size}) => <svg className="icon" style={{width: size, height: size}} viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Save: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Languages: ({className}) => <svg className={`icon ${className}`} viewBox="0 0 24 24"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
        };

        const { useState, useEffect } = React;

        // --- UI COMPONENTS ---

        const Card = ({ children, className = "", style = {} }) => (
            <div className={`card ${className}`} style={style}>{children}</div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, title = "", style = {} }) => (
            <button onClick={onClick} className={`btn btn-${variant} ${className}`} disabled={disabled} title={title} style={style}>
                {children}
            </button>
        );

        const ShiftSlot = ({ label, person, isLocked, candidates, onChange, onToggleLock, colorTheme = "blue", placeholder = "Select Staff", displayValue, subtitle }) => {
            const themeClass = `theme-${colorTheme}`;
            
            return (
                <div className={`slot ${themeClass} ${isLocked ? 'locked' : ''}`}>
                    <div className="slot-header">
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">{label}</span>
                        {onToggleLock && (
                            <button onClick={onToggleLock} className="btn-icon" style={{padding: '2px'}} title={isLocked ? "Unlock slot" : "Lock slot"}>
                                {isLocked ? <Icons.Lock size={12} /> : <Icons.Unlock size={12} />}
                            </button>
                        )}
                    </div>

                    <div className="slot-content">
                        <Icons.User className="icon" />
                        <select 
                            className="slot-select"
                            value={displayValue !== undefined ? displayValue : (person?.id || "")}
                            onChange={(e) => onChange(e.target.value ? parseInt(e.target.value) : null)}
                        >
                            <option value="">{placeholder}</option>
                            {label === 'Floater' && <option value="-1">Internal Cover</option>}
                            {candidates.map(c => (
                                <option key={c.id} value={c.id}>
                                    {c.name} {c.roles.includes('junior') ? '(Jnr)' : ''}
                                </option>
                            ))}
                        </select>
                    </div>
                    {subtitle && <div className="text-xs font-bold mt-1 opacity-80 truncate">{subtitle}</div>}
                </div>
            );
        };

        // --- MAIN APP ---

        function RotaGenerator() {
            // State
            const [staff, setStaff] = useState([
                { id: 1, name: 'Ver-se Abudar', roles: ['floater', 'farsi'] },
                { id: 2, name: 'Tim Groves', roles: ['floater'] },
                { id: 3, name: 'Andy Baxter', roles: ['main', 'floater'] },
                { id: 4, name: 'Izzy Ross', roles: ['main', 'junior'] },
                { id: 5, name: 'Titi Obawole', roles: ['main', 'junior'] },
                { id: 6, name: 'Chibueze Okpara', roles: ['main', 'junior'] },
                { id: 7, name: 'Simon McClure', roles: ['main'] },
                { id: 8, name: 'Neil Harper', roles: ['main'] },
                { id: 9, name: 'Jonathan Palmer', roles: ['main', 'junior'] },
            ]);
            
            const [newStaffName, setNewStaffName] = useState('');
            const [newStaffRoles, setNewStaffRoles] = useState({ main: true, floater: false, junior: false, farsi: false });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM
            const [rota, setRota] = useState([]);
            const [savedRotas, setSavedRotas] = useState({});
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [error, setError] = useState(null);
            const [isCopied, setIsCopied] = useState(false);

            useEffect(() => {
                const savedData = localStorage.getItem('sunday-rota-v2');
                const savedStaff = localStorage.getItem('sunday-staff-v2');
                if (savedData) setSavedRotas(JSON.parse(savedData));
                if (savedStaff) setStaff(JSON.parse(savedStaff));
            }, []);

            useEffect(() => {
                localStorage.setItem('sunday-staff-v2', JSON.stringify(staff));
            }, [staff]);

            useEffect(() => {
                setError(null);
                if (savedRotas[selectedDate]) {
                    const loadedRota = savedRotas[selectedDate].map(r => ({ ...r, date: new Date(r.date) }));
                    setRota(loadedRota);
                    setHasUnsavedChanges(false);
                } else {
                    setRota([]);
                    setHasUnsavedChanges(false);
                }
            }, [selectedDate, savedRotas]);

            const getSundaysInMonth = (year, month) => {
                const date = new Date(year, month - 1, 1);
                const sundays = [];
                while (date.getDay() !== 0) date.setDate(date.getDate() + 1);
                while (date.getMonth() === month - 1) {
                    sundays.push(new Date(date));
                    date.setDate(date.getDate() + 7);
                }
                return sundays;
            };

            const getBaselineUsage = (currentMonthKey) => {
                const baseline = {};
                staff.forEach(s => baseline[s.id] = 0);
                Object.keys(savedRotas).forEach(monthKey => {
                    if (monthKey !== currentMonthKey) {
                        savedRotas[monthKey].forEach(r => {
                            if (r.main1) baseline[r.main1.id] = (baseline[r.main1.id] || 0) + 1;
                            if (r.main2) baseline[r.main2.id] = (baseline[r.main2.id] || 0) + 1;
                            if (r.floater) baseline[r.floater.id] = (baseline[r.floater.id] || 0) + 1;
                            if (r.farsi) baseline[r.farsi.id] = (baseline[r.farsi.id] || 0) + 1;
                        });
                    }
                });
                return baseline;
            };

            const handleSaveMonth = () => {
                if (rota.length === 0) return;
                const newSaved = { ...savedRotas, [selectedDate]: rota };
                setSavedRotas(newSaved);
                localStorage.setItem('sunday-rota-v2', JSON.stringify(newSaved));
                setHasUnsavedChanges(false);
            };

            const handleDeleteMonth = () => {
                if (!window.confirm("Delete saved rota for this month?")) return;
                const newSaved = { ...savedRotas };
                delete newSaved[selectedDate];
                setSavedRotas(newSaved);
                localStorage.setItem('sunday-rota-v2', JSON.stringify(newSaved));
                setRota([]);
            };

            const handleSlotChange = (shiftIndex, slotKey, staffId) => {
                const newRota = [...rota];
                const shift = { ...newRota[shiftIndex] };
                
                // Update the specific slot
                if (slotKey === 'floater' && staffId === -1) {
                    shift.floater = null;
                } else {
                    const person = staff.find(s => s.id === staffId);
                    shift[slotKey] = person || null;
                }

                // Dynamic cover re-calculation for the Floater slot
                if (!shift.floater) {
                    const m1F = shift.main1?.roles.includes('floater');
                    const m2F = shift.main2?.roles.includes('floater');
                    if (m1F || m2F) {
                        shift.coveredBy = m1F ? shift.main1 : shift.main2;
                    } else {
                        shift.coveredBy = null; // Unassigned
                    }
                } else {
                    shift.coveredBy = null; // Has a dedicated floater
                }
                
                newRota[shiftIndex] = shift;
                setRota(newRota);
                setHasUnsavedChanges(true);
            };

            const toggleLock = (shiftIndex, slotKey) => {
                const newRota = [...rota];
                const lockKey = slotKey + 'Locked';
                newRota[shiftIndex] = { ...newRota[shiftIndex], [lockKey]: !newRota[shiftIndex][lockKey] };
                setRota(newRota);
                setHasUnsavedChanges(true);
            };

            const toggleStaffRole = (staffId, role) => {
                setStaff(staff.map(s => {
                    if (s.id !== staffId) return s;
                    const newRoles = s.roles.includes(role) 
                        ? s.roles.filter(r => r !== role)
                        : [...s.roles, role];
                    
                    if (role === 'junior' && !s.roles.includes('junior')) {
                        if (!newRoles.includes('main')) newRoles.push('main');
                        return { ...s, roles: newRoles.filter(r => r !== 'floater') };
                    }
                    return { ...s, roles: newRoles };
                }));
                setHasUnsavedChanges(true);
            };

            const generateRota = () => {
                setError(null);
                const [year, month] = selectedDate.split('-').map(Number);
                const sundays = getSundaysInMonth(year, month);
                const baselineUsage = getBaselineUsage(selectedDate);
                
                let bestResult = null;
                let bestStdDev = Infinity;
                const currentRotaState = rota.length === sundays.length ? rota : [];

                for (let i = 0; i < 50; i++) {
                    try {
                        const result = attemptGenerate(sundays, baselineUsage, currentRotaState);
                        const juniors = staff.filter(s => s.roles.includes('junior'));
                        const constraintsMet = juniors.every(j => result.usage[j.id] >= 1);

                        const totalUsage = { ...baselineUsage };
                        Object.entries(result.usage).forEach(([id, count]) => totalUsage[id] = (totalUsage[id] || 0) + count);
                        const values = Object.values(totalUsage);
                        const mean = values.reduce((a, b) => a + b, 0) / values.length;
                        const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                        const stdDev = Math.sqrt(variance);

                        if (!bestResult || (constraintsMet && stdDev < bestStdDev)) {
                            bestResult = result;
                            bestStdDev = stdDev;
                        }
                    } catch (e) {}
                }

                if (bestResult) {
                    setRota(bestResult.rota);
                    setHasUnsavedChanges(true);
                } else {
                    setError("Locked slots caused a conflict. Try unlocking some slots.");
                }
            };

            const attemptGenerate = (sundays, baselineUsage, currentRota) => {
                const usage = {};
                staff.forEach(s => usage[s.id] = 0);
                const tempRota = [];

                const getScore = (person) => {
                    const total = (baselineUsage[person.id] || 0) + usage[person.id];
                    let score = total * 100; 
                    if (person.roles.includes('junior') && usage[person.id] < 1) score -= 1000;
                    score += Math.random() * 50;
                    return score;
                };

                sundays.forEach((sunday, idx) => {
                    const existing = currentRota[idx];
                    const isSameDate = existing && existing.date.getDate() === sunday.getDate();
                    
                    const lockedMain1 = (isSameDate && existing.main1Locked) ? existing.main1 : null;
                    const lockedMain2 = (isSameDate && existing.main2Locked) ? existing.main2 : null;
                    const lockedFloater = (isSameDate && existing.floaterLocked) ? existing.floater : null;
                    const isFloaterLocked = isSameDate && existing.floaterLocked;

                    let main1 = lockedMain1;
                    if (!main1) {
                        const avail = staff.filter(s => s.roles.includes('main') && s.id !== lockedMain2?.id && s.id !== lockedFloater?.id);
                        avail.sort((a, b) => getScore(a) - getScore(b));
                        main1 = avail[0];
                    }
                    if (main1) usage[main1.id]++;

                    let main2 = lockedMain2;
                    if (!main2) {
                        const avail = staff.filter(s => s.roles.includes('main') && s.id !== main1?.id && s.id !== lockedFloater?.id);
                        avail.sort((a, b) => getScore(a) - getScore(b));
                        main2 = avail[0];
                    }
                    if (main2) usage[main2.id]++;

                    let floater = lockedFloater;
                    let coveredBy = null;
                    if (!isFloaterLocked) {
                        const m1F = main1?.roles.includes('floater');
                        const m2F = main2?.roles.includes('floater');
                        if (m1F || m2F) {
                            coveredBy = m1F ? main1 : main2;
                            floater = null;
                        } else {
                            const avail = staff.filter(s => s.roles.includes('floater') && s.id !== main1?.id && s.id !== main2?.id);
                            avail.sort((a, b) => getScore(a) - getScore(b));
                            floater = avail[0];
                        }
                    }
                    if (floater) usage[floater.id]++;

                    tempRota.push({
                        date: sunday,
                        main1, main2, floater, coveredBy,
                        farsi: isSameDate ? existing.farsi : null,
                        main1Locked: !!lockedMain1,
                        main2Locked: !!lockedMain2,
                        floaterLocked: isFloaterLocked
                    });
                });

                return { rota: tempRota, usage };
            };

            const addStaff = () => {
                if (!newStaffName.trim()) return;
                const roles = [];
                if (newStaffRoles.main) roles.push('main');
                if (newStaffRoles.floater) roles.push('floater');
                if (newStaffRoles.junior) roles.push('junior');
                if (newStaffRoles.farsi) roles.push('farsi');
                
                setStaff([...staff, { id: Date.now(), name: newStaffName, roles }]);
                setNewStaffName('');
                setNewStaffRoles({ main: true, floater: false, junior: false, farsi: false });
            };

            const removeStaff = (id) => {
                if (window.confirm("Remove this staff member?")) setStaff(staff.filter(s => s.id !== id));
            };

            const copyToClipboard = () => {
                if (!rota.length) return;
                const text = rota.map(r => {
                    const dateStr = r.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    const dutyText = `${r.main1?.name} & ${r.main2?.name}`;
                    const floatText = r.floater ? `+ Floater: ${r.floater.name}` : `(Cover by ${r.coveredBy?.name || 'Internal'})`;
                    const farsiText = r.farsi ? ` | Farsi: ${r.farsi.name}` : '';
                    return `${dateStr}: ${dutyText} ${floatText}${farsiText}`;
                }).join('\n');
                
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); } catch (e) {}
                document.body.removeChild(textArea);
            };

            return (
                <div className="container">
                    <header className="header-row flex justify-between items-center mb-8 gap-4">
                        <div>
                            <h1 className="flex items-center gap-2" style={{fontSize: '1.8rem', fontWeight: 900, color: 'var(--slate-900)'}}>
                                <Icons.Calendar className="icon icon-lg" style={{color: 'var(--blue-600)'}} />
                                Sunday Rota Pro
                            </h1>
                        </div>
                        <div className="input-group">
                             <span className="text-sm font-bold uppercase tracking-tighter px-2" style={{color: 'var(--slate-400)'}}>Target Month:</span>
                             <input 
                               type="month" 
                               value={selectedDate}
                               onChange={(e) => setSelectedDate(e.target.value)}
                               className="form-input"
                               style={{border: 'none', background: 'transparent', width: 'auto', fontWeight: 'bold'}}
                             />
                        </div>
                    </header>

                    <div className="main-grid">
                        <div className="flex flex-col gap-6">
                            <Card className="p-5">
                                <h2 className="text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2" style={{color: 'var(--slate-500)'}}>
                                    <Icons.Users className="icon" /> Staff Management
                                </h2>
                                
                                <div className="p-4 rounded-xl mb-6" style={{background: 'var(--slate-50)', border: '1px solid var(--slate-200)'}}>
                                    <input
                                        type="text"
                                        placeholder="Full Name..."
                                        className="form-input mb-3"
                                        value={newStaffName}
                                        onChange={(e) => setNewStaffName(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && addStaff()}
                                    />
                                    <div className="grid grid-cols-2 gap-2 mb-3" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px'}}>
                                        <div className={`role-checkbox ${newStaffRoles.main ? 'active-main' : ''}`} onClick={() => setNewStaffRoles({...newStaffRoles, main: !newStaffRoles.main})}>Main</div>
                                        <div className={`role-checkbox ${newStaffRoles.floater ? 'active-floater' : ''}`} onClick={() => setNewStaffRoles({...newStaffRoles, floater: !newStaffRoles.floater})}>Floater</div>
                                        <div className={`role-checkbox ${newStaffRoles.junior ? 'active-junior' : ''}`} onClick={() => setNewStaffRoles({...newStaffRoles, junior: !newStaffRoles.junior})}>Junior</div>
                                        <div className={`role-checkbox ${newStaffRoles.farsi ? 'active-farsi' : ''}`} onClick={() => setNewStaffRoles({...newStaffRoles, farsi: !newStaffRoles.farsi})}>Farsi</div>
                                    </div>
                                    <Button onClick={addStaff} className="w-full" variant="secondary">
                                        <Icons.Plus className="icon" /> Add Person
                                    </Button>
                                </div>

                                <div className="scroll-area">
                                    <div className="flex flex-col gap-2">
                                        {staff.map(person => (
                                            <div key={person.id} className="flex justify-between items-center p-3 rounded-xl" style={{border: '1px solid var(--slate-100)', background: 'white'}}>
                                                <div className="flex-1 truncate mr-2">
                                                    <div className="font-semibold text-slate-800 text-sm truncate">{person.name}</div>
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        <span className={`badge ${person.roles.includes('main') ? 'badge-blue' : 'badge-gray'}`} onClick={() => toggleStaffRole(person.id, 'main')}>Main</span>
                                                        <span className={`badge ${person.roles.includes('floater') ? 'badge-orange' : 'badge-gray'}`} onClick={() => toggleStaffRole(person.id, 'floater')}>Float</span>
                                                        <span className={`badge ${person.roles.includes('junior') ? 'badge-purple' : 'badge-gray'}`} onClick={() => toggleStaffRole(person.id, 'junior')}>Jnr</span>
                                                        <span className={`badge ${person.roles.includes('farsi') ? 'badge-rose' : 'badge-gray'}`} onClick={() => toggleStaffRole(person.id, 'farsi')}>Farsi</span>
                                                    </div>
                                                </div>
                                                <button onClick={() => removeStaff(person.id)} className="btn-icon">
                                                    <Icons.Trash2 />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </Card>
                        </div>

                        <div className="flex flex-col gap-6">
                            <div className="card p-4 flex flex-wrap items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <Button onClick={generateRota} style={{minWidth: '160px'}}>
                                        <Icons.RefreshCw className="icon" /> {rota.length > 0 ? "Regenerate" : "Generate"}
                                    </Button>
                                    {rota.length > 0 && (
                                        <Button onClick={handleSaveMonth} variant={hasUnsavedChanges ? "success" : "secondary"}>
                                            <Icons.Save className="icon" /> {hasUnsavedChanges ? "Save Changes" : "Saved"}
                                        </Button>
                                    )}
                                </div>
                                <div className="flex items-center gap-2">
                                    {savedRotas[selectedDate] && (
                                        <Button onClick={handleDeleteMonth} variant="danger" title="Delete Saved">
                                            <Icons.Trash2 />
                                        </Button>
                                    )}
                                    {rota.length > 0 && (
                                        <Button onClick={copyToClipboard} variant="secondary">
                                            {isCopied ? <Icons.Check className="icon" style={{color:'green'}} /> : <Icons.Copy className="icon" />}
                                            {isCopied ? "Copied" : "Copy"}
                                        </Button>
                                    )}
                                </div>
                            </div>

                            {error && (
                                <div style={{background: 'var(--red-50)', borderLeft: '4px solid var(--red-500)', padding: '16px', borderRadius: '0 8px 8px 0', display: 'flex', gap: '12px'}}>
                                    <Icons.AlertCircle style={{color: 'var(--red-600)'}} />
                                    <p style={{color: 'var(--red-600)', margin: 0}}>{error}</p>
                                </div>
                            )}

                            {rota.length > 0 ? (
                                <div className="animate-in flex flex-col gap-6">
                                    <div className="shift-grid">
                                        {rota.map((shift, idx) => (
                                            <Card key={idx} className="overflow-hidden" style={{borderLeft: '4px solid var(--blue-500)'}}>
                                                <div className="p-4" style={{background: 'var(--slate-50)', borderBottom: '1px solid var(--slate-100)', display: 'flex', justifyContent: 'space-between'}}>
                                                    <div>
                                                        <h3 className="font-bold text-slate-800">
                                                            {shift.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' })}
                                                        </h3>
                                                    </div>
                                                    <span className="text-xs font-black uppercase text-slate-400">Week {idx + 1}</span>
                                                </div>
                                                
                                                <div className="p-5 flex flex-col gap-4">
                                                    <div className="grid grid-cols-2 gap-3" style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'12px'}}>
                                                        <ShiftSlot 
                                                            label="Main 1"
                                                            person={shift.main1}
                                                            isLocked={shift.main1Locked}
                                                            candidates={staff.filter(s => s.roles.includes('main'))}
                                                            onChange={(id) => handleSlotChange(idx, 'main1', id)}
                                                            onToggleLock={() => toggleLock(idx, 'main1')}
                                                        />
                                                        <ShiftSlot 
                                                            label="Main 2"
                                                            person={shift.main2}
                                                            isLocked={shift.main2Locked}
                                                            candidates={staff.filter(s => s.roles.includes('main'))}
                                                            onChange={(id) => handleSlotChange(idx, 'main2', id)}
                                                            onToggleLock={() => toggleLock(idx, 'main2')}
                                                        />
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-3" style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'12px'}}>
                                                        <ShiftSlot 
                                                            label="Floater"
                                                            person={shift.floater}
                                                            displayValue={!shift.floater && shift.coveredBy ? "-1" : (shift.floater?.id || "")}
                                                            subtitle={!shift.floater && shift.coveredBy ? `By ${shift.coveredBy.name}` : ""}
                                                            isLocked={shift.floaterLocked}
                                                            candidates={staff.filter(s => s.roles.includes('floater'))}
                                                            onChange={(id) => handleSlotChange(idx, 'floater', id)}
                                                            onToggleLock={() => toggleLock(idx, 'floater')}
                                                            colorTheme={!shift.floater && shift.coveredBy ? "emerald" : "orange"}
                                                        />
                                                        
                                                        <ShiftSlot 
                                                            label="Farsi Speaker"
                                                            person={shift.farsi}
                                                            candidates={staff.filter(s => s.roles.includes('farsi'))}
                                                            onChange={(id) => handleSlotChange(idx, 'farsi', id)}
                                                            colorTheme="rose"
                                                            placeholder="Assign Manual"
                                                        />
                                                    </div>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>

                                    <Card className="p-6" style={{background: 'var(--slate-900)', color: 'white'}}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                                            <Icons.History className="icon" /> Accumulated Service History
                                        </h3>
                                        <div className="stats-grid">
                                            {staff.map((person) => {
                                                const currentMonthCount = rota.reduce((acc, r) => {
                                                    let c = 0;
                                                    if (r.main1?.id === person.id) c++;
                                                    if (r.main2?.id === person.id) c++;
                                                    if (r.floater?.id === person.id) c++;
                                                    if (r.farsi?.id === person.id) c++;
                                                    return acc + c;
                                                }, 0);
                                                const history = getBaselineUsage(selectedDate)[person.id] || 0;
                                                const total = currentMonthCount + history;
                                                return (
                                                    <div key={person.id} className="p-3 rounded-lg" style={{background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)'}}>
                                                        <div className="flex justify-between items-start">
                                                            <span className="text-xs text-slate-400 truncate">{person.name}</span>
                                                            {currentMonthCount > 0 && <span className="text-xs text-emerald-400 font-bold">+{currentMonthCount}</span>}
                                                        </div>
                                                        <div className="text-xl font-black mt-1">{total}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </Card>
                                </div>
                            ) : (
                                <div style={{height: '300px', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', border: '2px dashed var(--slate-300)', borderRadius: '20px', color: 'var(--slate-400)'}}>
                                    <Icons.Calendar className="mb-4" style={{width: '64px', height: '64px', opacity: 0.2}} />
                                    <p className="font-bold">No schedule for {new Date(selectedDate).toLocaleString('default', { month: 'long', year:'numeric' })}</p>
                                    <p className="text-sm">Click Generate to start.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RotaGenerator />);
    </script>
</body>
</html>
